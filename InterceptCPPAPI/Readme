-----------------------------------------------------------------------------
Build and Install cmd = 

#building CPP ats_mod_fcgi.so
/home/rahul/GDBTech/ATS/opt/ts-7.1/bin/tsxs -o ats_mod_fcgi.so -c ats_mod_fcgi.cc
  -L /home/rahul/GDBTech/ATS/opt/ts-7.1/lib/ 
  -I /home/rahul/GDBTech/ATS/trafficserver-7.1.1/lib 
  -I /home/rahul/GDBTech/ATS/trafficserver-7.1.1/lib/cppapi/include/ 
  -c fcgi_intercept.cc -latscppapi 
  && sudo /home/rahul/GDBTech/ATS/opt/ts-7.1/bin/tsxs -o ats_mod_fcgi.so  -i

OR Build and install using Makefile utility:
  Before doing make Plz set below directories.
  # 1. TSXS  						--path to tsxs script file present under path/to/ts/bin/tsxs
  # 2. MOD_FCGI_DIR   			--specify the directory where ats_mod_fcgi plugin src is present.
  # 3. TRAFFIC_SERVER_SRC_DIR		--path to traffic server src directory 
  # 4. TRAFFIC_SERVER_EXEC_DIR    --path to traffic server exec directory

  Afterwords command, $> make && sudo make install
------------------------------------------------------------------------------

ATS (Apache Traffic Server) FastCGI Plugin
------------------------------------------------------------------------------

This plugin collapses connections with identical CacheUrl/EffectiveUrl.

If an entry was created for a given CacheUrl/EffectiveUrl in our global hashTable,
successive GET requests with identical CacheUrl/EffectiveUrl will be blocked in 
POST_REMAP hook until the hash entry was removed.  (POST_REMAP hook is the last 
hook before 'cache lookup')

For requests going into 'cache lookup' stage,
  if CacheLookupStatus is HIT_FRESH,
    hash entry will be removed at earliest possible time.

For requests going into 'read server response header' stage,
  if response is not 200 OK,
    hash entry will be removed at earliest possible time.
  if response is public cacheable, (by checking 'Expires' header and 'Cache-Control' header with 'public' & 'max-age=...' values),
    if proxy.config.cache.enable_read_while_writer is enabled,
      hash entry will be removed at earliest possible time.
    else
      hash entry will be removed in TXN_CLOSE hook. 
  if response is not public cacheable,
    we will update hash entry with a special value to let successive requests pass collapsed check,
    this special hash entry will be removed in TXN_CLOSE hook if value of keep_pass_record_time is 0,
    else it will be added into a list with timeout and removed by later collapsed requests.

To view full state diagram, please view state.png


CONFIGURATION

To have trafficserver use this plugin, add a line for 'ats_mod_fcgi.so' in the 'plugin.config' file.
The plugin can be configured with only 1 argument, which is location of its configuration file.

Example plugin.config:
    ats_mod_fcgi.so conf/ats_mod_fcgi/ats_mod_fcgi_XXXNAME.config

This plugin can be added in remap.config as well.
Thus, it can have different configurations or only be enabled/disabled for specific remap rules.
If the only argument for this plugin is "0" or "1", it means just "disable" or "enable" this plugin with default config value.

Example remap.config:
    map http://no-collapse1.www.example.com/ http://www.example.com/ @plugin=ats_mod_fcgi.so @pparam=0
    map http://no-collapse2.www.example.com/ http://www.example.com/ @plugin=ats_mod_fcgi.so @pparam=conf/collapsed_connection/disable.config

Its configuration file can have 5 configurable options:
    CONFIG proxy.config.http.fcgi.enabled INT 1
    CONFIG proxy.config.http.fcgi.host.hostname STRING localhost
    CONFIG proxy.config.http.fcgi.host.server_ip  STRING 127.0.0.1
    CONFIG proxy.config.http.fcgi.host.server_port STRING 60000
    CONFIG proxy.config.http.fcgi.host.root_directory STRING /

Meaning of these configurable options:
    enabled
        enable fcgi Server or not, useful in remap rules if we want to disable/enable specific remap rules.
    hostname
        hostname of the fcgi server in string format e.g localhost
    server_ip
        IP of the fcgi server machine in string format e.g 127.0.0.1
    servre_port
        fcgi server port number in string format e.g 60000
    root_directory
        root directory path from where fcgi server will server resources/web_contents
        

